# Kubernetes Deployment Guide for AI Trading Robot

This directory contains Kubernetes manifests for deploying the AI Trading Robot in a production environment.

## üìÅ Files Overview

### deployment.yaml
- **Main Deployment**: Manages the trading bot pods with 3 replicas for high availability
- **HorizontalPodAutoscaler**: Auto-scales between 3-10 pods based on CPU/Memory/Custom metrics
- **PodDisruptionBudget**: Ensures at least 2 pods are always available during updates
- **Security Features**: 
  - Non-root user execution
  - Read-only root filesystem
  - Security contexts and capabilities drop
- **Health Checks**: Liveness, Readiness, and Startup probes
- **Resource Management**: CPU/Memory requests and limits
- **Sidecar Container**: Fluent Bit for log shipping

### service.yaml
- **ClusterIP Service**: Internal service for pod communication
- **Headless Service**: For direct pod-to-pod communication
- **LoadBalancer Service**: External access (optional)
- **Metrics Service**: Dedicated service for Prometheus scraping
- **ServiceMonitor**: For Prometheus Operator integration
- **NetworkPolicy**: Security rules for ingress/egress traffic
- **Ingress**: HTTPS routing with TLS termination

### configmap.yaml
- **Application Configuration**: All non-sensitive configuration data
- **Trading Parameters**: Strategies, risk limits, ML settings
- **Infrastructure Config**: Database, Redis, Kafka connections
- **Monitoring Config**: Metrics, logging, alerting thresholds
- **Fluent Bit Config**: Log parsing and shipping configuration
- **Prometheus Alerts**: Trading-specific alert rules

## üöÄ Deployment Steps

### Prerequisites
- Kubernetes cluster (1.24+)
- kubectl configured
- Helm 3 (for dependencies)
- Persistent storage provisioner
- Ingress controller (nginx recommended)

### 1. Create Namespace
```bash
kubectl create namespace trading
```

### 2. Install Dependencies

#### PostgreSQL with TimescaleDB
```bash
helm repo add timescale https://charts.timescale.com
helm install postgres timescale/timescaledb-single \
  --namespace trading \
  --set image.tag=latest-pg15 \
  --set postgresql.auth.database=trading \
  --set postgresql.auth.username=trader \
  --set postgresql.auth.password=<secure-password> \
  --set persistence.size=100Gi
```

#### Redis
```bash
helm repo add bitnami https://charts.bitnami.com/bitnami
helm install redis bitnami/redis \
  --namespace trading \
  --set auth.enabled=true \
  --set auth.password=<secure-password> \
  --set replica.replicaCount=3 \
  --set sentinel.enabled=true
```

#### Kafka (Optional for event streaming)
```bash
helm install kafka bitnami/kafka \
  --namespace trading \
  --set replicaCount=3 \
  --set persistence.size=50Gi
```

### 3. Create Secrets
```bash
# Create secret for sensitive data
kubectl create secret generic trading-bot-secrets \
  --namespace trading \
  --from-literal=DATABASE_URL="postgresql://trader:<password>@postgres-service:5432/trading" \
  --from-literal=REDIS_URL="redis://:<password>@redis-service:6379/0" \
  --from-literal=BINANCE_API_KEY="<your-api-key>" \
  --from-literal=BINANCE_API_SECRET="<your-api-secret>" \
  --from-literal=SLACK_WEBHOOK_URL="<your-webhook-url>"
```

### 4. Apply Kubernetes Manifests
```bash
# Apply in order
kubectl apply -f configmap.yaml
kubectl apply -f service.yaml
kubectl apply -f deployment.yaml
```

### 5. Verify Deployment
```bash
# Check pods
kubectl get pods -n trading

# Check services
kubectl get svc -n trading

# Check HPA
kubectl get hpa -n trading

# View logs
kubectl logs -n trading -l app=trading-bot --tail=100
```

## üîß Configuration

### Environment-Specific Settings
Modify the ConfigMap for different environments:
- `TRADING_MODE`: Set to "paper" for testing
- `ML_ENABLED`: Disable for simpler deployments
- `ENABLED_STRATEGIES`: Choose active strategies

### Resource Allocation
Adjust in deployment.yaml based on your needs:
```yaml
resources:
  requests:
    memory: "2Gi"    # Minimum for basic operation
    cpu: "1000m"     # 1 CPU core
  limits:
    memory: "4Gi"    # Increase for ML models
    cpu: "2000m"     # 2 CPU cores
```

### Scaling Configuration
Modify HPA settings:
```yaml
minReplicas: 3      # Minimum pods
maxReplicas: 10     # Maximum pods
averageUtilization: 70  # Target CPU usage
```

## üìä Monitoring

### Prometheus Metrics
The trading bot exposes metrics on port 9090:
- Trading performance metrics
- System resource usage
- Custom business metrics

### Grafana Dashboards
Import the provided dashboards for:
- Trading performance overview
- Risk metrics monitoring
- System health dashboard

### Alerts
Pre-configured alerts include:
- High error rate (>5%)
- High latency (>1s)
- Pod restarts
- High CPU/Memory usage
- Trading-specific: No trades, High drawdown, Connection losses

## üîí Security Considerations

1. **Network Policies**: Restrict traffic between pods
2. **RBAC**: Use ServiceAccount with minimal permissions
3. **Secrets Management**: Use Kubernetes secrets or external secret managers
4. **TLS**: Enable TLS for all external communications
5. **Pod Security**: Run as non-root, read-only filesystem

## üõ†Ô∏è Troubleshooting

### Common Issues

1. **Pods not starting**
   ```bash
   kubectl describe pod <pod-name> -n trading
   kubectl logs <pod-name> -n trading -c trading-bot
   ```

2. **Database connection issues**
   - Verify secrets are created correctly
   - Check network policies
   - Ensure database is running

3. **High memory usage**
   - Check for memory leaks
   - Adjust JVM heap size if using Java components
   - Review ML model sizes

4. **Exchange API errors**
   - Verify API credentials in secrets
   - Check rate limits
   - Review network egress rules

### Debugging Commands
```bash
# Execute shell in pod
kubectl exec -it <pod-name> -n trading -- /bin/sh

# Port forward for local debugging
kubectl port-forward -n trading svc/trading-bot-service 8080:80

# View recent events
kubectl get events -n trading --sort-by='.lastTimestamp'

# Check resource usage
kubectl top pods -n trading
```

## üîÑ Updates and Rollbacks

### Rolling Update
```bash
# Update image
kubectl set image deployment/trading-bot trading-bot=trading-bot:v1.1.0 -n trading

# Check rollout status
kubectl rollout status deployment/trading-bot -n trading
```

### Rollback
```bash
# Rollback to previous version
kubectl rollout undo deployment/trading-bot -n trading

# Rollback to specific revision
kubectl rollout undo deployment/trading-bot --to-revision=2 -n trading
```

## üìà Performance Tuning

1. **Database Optimization**
   - Use connection pooling
   - Optimize queries with indexes
   - Enable query caching

2. **Redis Optimization**
   - Use Redis Cluster for high availability
   - Implement proper key expiration
   - Monitor memory usage

3. **Application Optimization**
   - Enable JIT compilation for Python
   - Use async operations where possible
   - Implement proper caching strategies

## üìù Maintenance

### Regular Tasks
- Monitor resource usage and adjust limits
- Review and rotate logs
- Update dependencies and base images
- Backup configuration and secrets
- Test disaster recovery procedures

### Health Checks
The application provides three health endpoints:
- `/health/live`: Liveness check
- `/health/ready`: Readiness check  
- `/health/startup`: Startup check

## üÜò Support

For issues or questions:
1. Check application logs
2. Review Kubernetes events
3. Consult monitoring dashboards
4. Check alert notifications

---

**Note**: Always test configuration changes in a staging environment before applying to production.